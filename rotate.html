<!DOCTYPE html>
<html>
	<meta charset="utf-8">
	<style>
	  body {
		display: flex;
 	  	justify-content: center;
	  }
	  .flex-container{
		display: flex;
		align-items: center;
		flex-direction: column;
	  }
	  .target {
		display: flex;
		width: 300px;
		height: 300px;
		justify-content: center;
  		align-items: center;
	  }
	  #target:hover {
 	  	color: orange;
  	  	cursor: pointer;
 	 }
	</style>
	<body>
		<div class="flex-container">
			<div class="target">
				<img src="noise.webp" id="noise" style="width: 560px; height: 315px; position: absolute; z-index: 2; opacity: 1;">
				<div id="player" style="z-index: 1; position: absolute;"></div>
			</div>
			<div style="display: flex; flex-direction: row;">
				<div id="target1" class="target"><img src="swf_dump-4.png" style="height: 150px; width: 150px;"></div>
				<div id="target2" class="target"><img src="swf_dump-4.png" style="height: 150px; width: 150px;"></div>
			</div>
			<button id="testingbutton">Go!</button>
			<input type="text" id="videourl">
		</div>
		<audio id="audionoise" src="noise.mp3" preload="auto" loop="true" autoplay="true"></audio>
 	 <!-- Thanks J. Voigt of https://bl.ocks.org/joyrexus/7207044! -->
	<script src="rotate.js"></script>
	<script>
		lastRotationVideo = 0;
		lastRotationAudio = 0;
		videoQuality = 0;
		audioQuality = 0;
		document.getElementById("testingbutton").addEventListener("click", function(){
			document.getElementById("noise").style.zIndex = "2"
			var videoid = document.getElementById("videourl").value.replace(/https\:\/\/|www.youtube.com\/watch\?v=|www.youtu.be\//g, "")
			//Thanks Leo and Samina Zahid of Stack Overflow!
			var remove_after = videoid.indexOf("&");
			if (remove_after != -1) {
				var videoid = videoid.substring(0, remove_after);
			}
			player.loadVideoById({videoId: videoid});
			videoQuality = 0;
			audioQuality = 0;
			})
		videoQualityCheck();
		function videoQualityCheck() {
			var rotation = getRotation(target2);
			if (rotation < (lastRotationVideo - 300)) {
				if (target2.dataset.active == "true") {
					videoQuality += 360;
				}
			}
			if (rotation > (lastRotationVideo + 300)) {
				rotation -= rotation;
			} 
			lastRotationVideo = getRotation(target2);
			var videoQualityCheckTimeout = setTimeout(videoQualityCheck, 33)
			if (videoQuality > 3000) {
				videoQuality = 3000;
			}
			if (videoQuality > 0) {
				videoQuality -= (1.0009 ** videoQuality)/1.5;
			}
			// console.log(videoQuality);
			document.getElementById("noise").style.opacity = (1 -((rotation + videoQuality) / 2200));
		}
		audioQualityCheck();
		function audioQualityCheck() {
			var rotation = getRotation(target1);
			if (rotation < (lastRotationAudio - 300)) {
				if (target1.dataset.active == "true") {
					audioQuality += 360;
				}
			}
			if (rotation > (lastRotationAudio + 300)) {
				rotation -= rotation;
			} 
			lastRotationAudio = getRotation(target1);
			var audioQualityCheckTimeout = setTimeout(audioQualityCheck, 33)
			if (audioQuality > 3000) {
				audioQuality = 3000;
			}
			if (audioQuality > 0) {
				audioQuality -= (1.0009 ** audioQuality) + 2;
			}
			player.setVolume(((rotation + audioQuality)/22));
			document.getElementById("audionoise").play();
			document.getElementById("audionoise").volume = clamp((1 - ((rotation + audioQuality)/2200)), 0, 1)
		}
		target1 = document.getElementById("target1");
		target2 = document.getElementById("target2");
		function getRotation(target) {
			targetRotation = parseInt(target.style.transform.replace(/rotate\(|deg\)/g, ""));
			if (targetRotation < 0) {
				targetRotation = Math.abs(targetRotation += 360);
			}
			if (targetRotation > 360) {
				targetRotation -= 360
			}
			// console.log("Rotation: " + targetRotation)
			return targetRotation;
		}
		// Thanks CAFxX of Stack Overflow!
		function clamp(number, min, max) {
  			return Math.max(min, Math.min(number, max));
		}
	</script>
	<script>
		// 2. This code loads the IFrame Player API code asynchronously.
		var tag = document.createElement('script');
  
		tag.src = "https://www.youtube.com/iframe_api";
		var firstScriptTag = document.getElementsByTagName('script')[0];
		firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  
		// 3. This function creates an <iframe> (and YouTube player)
		//    after the API code downloads.

		function onYouTubeIframeAPIReady() {
			player = new YT.Player('player', {
				height: '315',
				width: '560',
				videoId: 'Zux_GebV374',
				playerVars: {
				'playsinline': 1
				},
				events: {
				'onReady': onPlayerReady,
				}
			});
			}
  
		// 4. The API will call this function when the video player is ready.
		function onPlayerReady(event) {
		  event.target.playVideo();
		  document.getElementById("audionoise").play();
		}
	  </script>
 	</body>
</html>
